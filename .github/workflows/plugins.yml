name: Main

on:
  workflow_call:
    inputs:
      skip-test:
        description: "Does we need to skip test"
        required: true
        type: boolean
      sonatype-publish:
        description: "Does we use gradle publish or sonatype publish"
        required: false
        type: boolean
        default: true
      runner:
        description: "The runner to use."
        required: false
        type: string
        default: "ubuntu-latest"
      generate-shadowjar:
        description: "Does we generate a shadow jar"
        required: false
        type: boolean
        default: true
      java-version:
        description: "Java version"
        type: string
        default: '21'
        required: false

permissions:
  contents: write
  checks: write
  actions: read
  pull-requests: write
  packages: read

jobs:
  main:
    runs-on: ${{ inputs.runner }}
    steps:
      # Check out
      - name: Checkout - Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      # Setup build
      - name: Setup - Build
        uses: kestra-io/actions/composite/setup-build@main
        with:
          java-enabled: true
          java-version: ${{ inputs.java-version }}

      # Setup for setup-unit.sh, injecting secrets as env variables
      - name: Setup - Secret to Env
        uses: oNaiPs/secrets-to-env-action@v1
        with:
          secrets: ${{ toJSON(secrets) }}

      # Auth to google with github are required for com.google.cloud.artifactregistry.gradle-plugin
      - name: GCP - Auth with github service account
        uses: 'google-github-actions/auth@v3'
        if: ${{ inputs.sonatype-publish == false }}
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # Setup unit tests environment
      - name: Setup - Unit test
        if: ${{ inputs.skip-test == false }}
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if [ -f .github/setup-unit.sh ]; then
            ./.github/setup-unit.sh 
          fi

      # Gradle check
      - name: Test - Gradle Check
        if: ${{ inputs.skip-test == false }}
        shell: bash
        run: ./gradlew check ${{ inputs.generate-shadowjar == true && 'shadowJar' || ''  }} --parallel
        env:
          JAVA_OPTS: "-Xmx2g -XX:MaxMetaspaceSize=1g"
          GITHUB_TOKEN: ${{ github.token }}

      # Cleanup unit tests environment
      - name: Cleanup - Unit test
        if: ${{ inputs.skip-test == false }}
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if [ -f .github/cleanup-unit.sh ]; then
            ./.github/cleanup-unit.sh
          fi

      # Publish
      - name: Publish - Java
        uses: kestra-io/actions/composite/publish-java@main
        if: ${{ (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')) && startsWith(github.repository, 'kestra-io/') }}
        with:
          secrets: ${{ toJSON(secrets) }}
          is-private: ${{ inputs.sonatype-publish == false }}

      # Upload JAR for PR
      - name: Publish - Jar artifacts for PR only
        uses: kestra-io/actions/composite/jar-upload@main
        if: ${{ inputs.generate-shadowjar == true && github.event_name == 'pull_request' && startsWith(github.repository, 'kestra-io/') }}
        with:
          secrets: ${{ toJSON(secrets) }}

      # Cleanup disk space to avoid "no space left on device" errors during Trivy scan
      - name: Cleanup - Free up disk space
        run: |
          echo "üßπ Freeing up disk space on the runner..."
          sudo docker system prune -a -f --volumes
          sudo apt-get autoremove -y
          sudo apt-get clean
          sudo apt-get autoclean

          echo "üóëÔ∏è Deleting large pre-installed tools (Dotnet, Android, Haskell)"
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android 
          sudo rm -rf /opt/ghc

          echo "‚ö†Ô∏è Deleting tmp folders"
          sudo rm -rf /tmp/*
          sudo rm -rf /var/tmp/*

          echo "üßº Deleting Trivy cache and temp directories"
          rm -rf ${{ github.workspace }}/.trivy-cache
          rm -rf ${{ github.workspace }}/trivy-tmp

          echo "üìä Disk usage after cleanup:"
          df -h

          echo "‚úÖ Disk space cleanup complete."

      # Trivy scan for PR
      - name: Trivy - Scan jar for PR only
        if: ${{ inputs.generate-shadowjar == true && github.event_name == 'pull_request' && startsWith(github.repository, 'kestra-io/') }}
        uses: kestra-io/actions/composite/scan-trivy@main
        with:
          secrets: ${{ toJSON(secrets) }}

      # GitHub Release
      - name: GitHub - Create release
        uses: kestra-io/actions/composite/github-release@main
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_RELEASES_WEBHOOK_URL: ${{ secrets.SLACK_RELEASES_WEBHOOK_URL }}

      # Report Java
      - name: Report - Java
        uses: kestra-io/actions/composite/report-java@main
        if: ${{ !cancelled() && inputs.skip-test == false }}
        with:
          secrets: ${{ toJSON(secrets) }}

      # Unreleased commits since latest release
      - name: Unreleased Commits - Comment pull request
        uses: kestra-io/actions/composite/unreleased-commits@main
        if: ${{ github.event_name == 'pull_request' }}
        with:
          secrets: ${{ toJSON(secrets) }}

      # Slack on error
      - name: Slack - Notify on failure
        id: send-ci-failed
        if: always() && env.SLACK_WEBHOOK_URL != '' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')) && job.status == 'failure'
        uses: kestra-io/actions/composite/slack-status@main
        with:
          channel: "C09FE0QCN2E"
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}

      # Allure report permissions
      - name: Allure report permissions
        if: ${{ !cancelled() && inputs.skip-test == false }}
        shell: bash
        run: |
          REPORT_DIR="build/reports/allure"
          
          # Check if the Allure report directory actually exists before attempting chown.
          # This prevents the "No such file or directory" error (EACCES context).
          if [ -d "$REPORT_DIR" ]; then
            echo "üîß Fixing permissions for Allure report directory: $REPORT_DIR"
            # Use chown to transfer ownership from 'root' (often the case after Docker build) 
            # to the GitHub Actions runner user, solving the EACCES error during 'unlink'.
            sudo chown -R $(whoami) "$REPORT_DIR"
          else
            echo "‚ÑπÔ∏è Allure report directory $REPORT_DIR not found. Skipping chown."
          fi

      # Index release
      - name: Index release
        uses: kestra-io/actions/composite/plugin-release-index@main
        # We trigger the plugin release index only for NON SNAPSHOT version thus the if:
        if: ${{ (startsWith(github.ref, 'releases/v') || startsWith(github.ref, 'refs/tags/v')) && startsWith(github.repository, 'kestra-io/') }}
        with:
          webhookUrl: "${{ secrets.KESTRA_WEBHOOK_URL_PLUGIN_RELEASE_INDEX }}"
